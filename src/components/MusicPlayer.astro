---
import "aplayer-ts/src/css/base.css";

interface Props {
	netease: string;
}
---

<div class="aplayer" data-id={Astro.props.netease}>音乐正在加载中 ...</div>

<script>
	import APlayer from "aplayer-ts";

	document.addEventListener("DOMContentLoaded", () => {
		const players = document.querySelectorAll(".aplayer");

		players.forEach(async (player) => {
			const container = player as HTMLElement;
			const songId = container.dataset.id;

			if (!songId) {
				container.textContent = "错误：未提供歌曲 ID。";
				return;
			}

			try {
				const [detailRes, urlRes] = await Promise.all([
					fetch(`/api/song-detail/${songId}`),
					fetch(`/api/song-url/${songId}`),
				]);

				if (!detailRes.ok || !urlRes.ok) {
					throw new Error("获取歌曲数据失败");
				}

				const songInfo = await detailRes.json();
				const songUrlData = await urlRes.json();

				const song = songInfo.songs[0];
				const urlInfo = songUrlData.data[0];

				if (!song || !urlInfo || !urlInfo.url) {
					throw new Error("无效的歌曲数据");
				}

				APlayer().init({
					container: container,
					audio: [
						{
							name: song.name,
							artist: song.ar.map((a: { name: any }) => a.name).join("/"),
							url: urlInfo.url,
							cover: song.al.picUrl,
							theme: "#ebd0c2",
						},
					],
				});
			} catch (error) {
				console.error("播放器初始化失败:", error);
				container.textContent = "歌曲加载失败，请稍后重试。";
			}
		});
	});
</script>
